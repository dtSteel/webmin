(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("../htmlmixed/htmlmixed"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../htmlmixed/htmlmixed"],a)}else{a(CodeMirror)}}})(function(a){var b=["template","literal","msg","fallbackmsg","let","if","elseif","else","switch","case","default","foreach","ifempty","for","call","param","deltemplate","delcall","log"];a.defineMode("soy",function(f){var i=a.getMode(f,"text/plain");var d={html:a.getMode(f,{name:"text/html",multilineTagIndentFactor:2,multilineTagIndentPastTag:false}),attributes:i,text:i,uri:i,css:a.getMode(f,"text/css"),js:a.getMode(f,{name:"text/javascript",statementIndent:2*f.indentUnit})};function j(l){return l[l.length-1]}function c(r,q,p){if(r.sol()){for(var m=0;m<q.indent;m++){if(!r.eat(/\s/)){break}}if(m){return null}}var n=r.string;var o=p.exec(n.substr(r.pos));if(o){r.string=n.substr(0,r.pos+o.index)}var l=r.hideFirstChars(q.indent,function(){var s=j(q.localStates);return s.mode.token(r,s.state)});r.string=n;return l}function g(m,l){while(m){if(m.element===l){return true}m=m.next}return false}function k(m,l){return{element:l,next:m}}function e(m,l,n){return g(m,l)?"variable-2":(n?"variable":"variable-2 error")}function h(l){if(l.scopes){l.variables=l.scopes.element;l.scopes=l.scopes.next}}return{startState:function(){return{kind:[],kindTag:[],soyState:[],templates:null,variables:null,scopes:null,indent:0,localStates:[{mode:d.html,state:a.startState(d.html)}]}},copyState:function(l){return{tag:l.tag,kind:l.kind.concat([]),kindTag:l.kindTag.concat([]),soyState:l.soyState.concat([]),templates:l.templates,variables:l.variables,scopes:l.scopes,indent:l.indent,localStates:l.localStates.map(function(m){return{mode:m.mode,state:a.copyState(m.mode,m.state)}})}},token:function(q,o){var m;switch(j(o.soyState)){case"comment":if(q.match(/^.*?\*\//)){o.soyState.pop()}else{q.skipToEnd()}return"comment";case"templ-def":if(m=q.match(/^\.?([\w]+(?!\.[\w]+)*)/)){o.templates=k(o.templates,m[1]);o.scopes=k(o.scopes,o.variables);o.soyState.pop();return"def"}q.next();return null;case"templ-ref":if(m=q.match(/^\.?([\w]+)/)){o.soyState.pop();if(m[0][0]=="."){return e(o.templates,m[1],true)}return"variable"}q.next();return null;case"param-def":if(m=q.match(/^\w+/)){o.variables=k(o.variables,m[0]);o.soyState.pop();o.soyState.push("param-type");return"def"}q.next();return null;case"param-type":if(q.peek()=="}"){o.soyState.pop();return null}if(q.eatWhile(/^[\w]+/)){return"variable-3"}q.next();return null;case"var-def":if(m=q.match(/^\$([\w]+)/)){o.variables=k(o.variables,m[1]);o.soyState.pop();return"def"}q.next();return null;case"tag":if(q.match(/^\/?}/)){if(o.tag=="/template"||o.tag=="/deltemplate"){h(o);o.indent=0}else{if(o.tag=="/for"||o.tag=="/foreach"){h(o)}o.indent-=f.indentUnit*(q.current()=="/}"||b.indexOf(o.tag)==-1?2:1)}o.soyState.pop();return"keyword"}else{if(q.match(/^([\w?]+)(?==)/)){if(q.current()=="kind"&&(m=q.match(/^="([^"]+)/,false))){var n=m[1];o.kind.push(n);o.kindTag.push(o.tag);var p=d[n]||d.html;var l=j(o.localStates);if(l.mode.indent){o.indent+=l.mode.indent(l.state,"")}o.localStates.push({mode:p,state:a.startState(p)})}return"attribute"}else{if(q.match(/^"/)){o.soyState.push("string");return"string"}}}if(m=q.match(/^\$([\w]+)/)){return e(o.variables,m[1])}if(m=q.match(/^\w+/)){return/^(?:as|and|or|not|in)$/.test(m[0])?"keyword":null}q.next();return null;case"literal":if(q.match(/^(?=\{\/literal})/)){o.indent-=f.indentUnit;o.soyState.pop();return this.token(q,o)}return c(q,o,/\{\/literal}/);case"string":var m=q.match(/^.*?("|\\[\s\S])/);if(!m){q.skipToEnd()}else{if(m[1]=='"'){o.soyState.pop()}}return"string"}if(q.match(/^\/\*/)){o.soyState.push("comment");return"comment"}else{if(q.match(q.sol()?/^\s*\/\/.*/:/^\s+\/\/.*/)){return"comment"}else{if(q.match(/^\{literal}/)){o.indent+=f.indentUnit;o.soyState.push("literal");return"keyword"}else{if(m=q.match(/^\{([\/@\\]?[\w?]*)/)){if(m[1]!="/switch"){o.indent+=(/^(\/|(else|elseif|ifempty|case|fallbackmsg|default)$)/.test(m[1])&&o.tag!="switch"?1:2)*f.indentUnit}o.tag=m[1];if(o.tag=="/"+j(o.kindTag)){o.kind.pop();o.kindTag.pop();o.localStates.pop();var l=j(o.localStates);if(l.mode.indent){o.indent-=l.mode.indent(l.state,"")}}o.soyState.push("tag");if(o.tag=="template"||o.tag=="deltemplate"){o.soyState.push("templ-def")}if(o.tag=="call"||o.tag=="delcall"){o.soyState.push("templ-ref")}if(o.tag=="let"){o.soyState.push("var-def")}if(o.tag=="for"||o.tag=="foreach"){o.scopes=k(o.scopes,o.variables);o.soyState.push("var-def")}if(o.tag.match(/^@(?:param\??|inject)/)){o.soyState.push("param-def")}return"keyword"}}}}return c(q,o,/\{|\s+\/\/|\/\*/)},indent:function(o,n){var l=o.indent,p=j(o.soyState);if(p=="comment"){return a.Pass}if(p=="literal"){if(/^\{\/literal}/.test(n)){l-=f.indentUnit}}else{if(/^\s*\{\/(template|deltemplate)\b/.test(n)){return 0}if(/^\{(\/|(fallbackmsg|elseif|else|ifempty)\b)/.test(n)){l-=f.indentUnit}if(o.tag!="switch"&&/^\{(case|default)\b/.test(n)){l-=f.indentUnit}if(/^\{\/switch\b/.test(n)){l-=f.indentUnit}}var m=j(o.localStates);if(l&&m.mode.indent){l+=m.mode.indent(m.state,n)}return l},innerMode:function(l){if(l.soyState.length&&j(l.soyState)!="literal"){return null}else{return j(l.localStates)}},electricInput:/^\s*\{(\/|\/template|\/deltemplate|\/switch|fallbackmsg|elseif|else|case|default|ifempty|\/literal\})$/,lineComment:"//",blockCommentStart:"/*",blockCommentEnd:"*/",blockCommentContinue:" * ",useInnerComments:false,fold:"indent"}},"htmlmixed");a.registerHelper("hintWords","soy",b.concat(["delpackage","namespace","alias","print","css","debugger"]));a.defineMIME("text/x-soy","soy")});